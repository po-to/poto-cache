define(["require","exports"],function(t,e){"use strict";function i(){return Math.floor(Date.now()/1e3)}function n(t,e){var i=w.serializations[t];return i?i.decode(e):e}function r(t,e){for(var i=[],n=2;n<arguments.length;n++)i[n-2]=arguments[n];for(var r=0,o=i;r<o.length;r++)for(var s=o[r],a=0,p=t;a<p.length;a++){var h=p[a];s.hasOwnProperty(h)&&(e[h]=s[h])}return e}function o(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];for(var n=0,r=e;n<r.length;n++){var o=r[n];for(var s in o)o.hasOwnProperty(s)&&(t[s]=o[s])}return t}function s(t){t.namespace&&(w.namespace=t.namespace),t.encryption&&(w.encryption=t.encryption),t.mappingKey&&(w.mappingKey=t.mappingKey),t.serializations&&o(w.serializations,t.serializations),t.request&&(O=t.request)}function a(t,e){t=w.mappingKey(t);var i;return void 0!==e?i=x[e].getItem(t):(e=y.Ram,i=x[e].getItem(t),i||(e=y.Session,i=x[e].getItem(t)),i||(e=y.Local,i=x[e].getItem(t))),i?new l(i.value,i.version,e):null}function p(t,e,i){t=w.mappingKey(t);var n=e.toOptions();return void 0===i&&(i=y.Ram),x[i].setItem(t,n)}function h(t,e){t=w.mappingKey(t),void 0!==e?x[e].removeItem(t):(x[y.Ram].removeItem(t),x[y.Session].removeItem(t),x[y.Local].removeItem(t))}function c(t){void 0!==t?x[t].clear():(x[y.Ram].clear(),x[y.Session].clear(),x[y.Local].clear())}function u(t,e,i){return new Promise(function(r,o){var s=function(n){var s=t.render?t.render(n):n;s instanceof Error?(i&&i(s),o(s)):(e&&e(s),r(s))},h=a(t.url);h&&!h.version?s(h.toData()):(h&&h.version&&(t.version=h.version),O(t,function(e){var i,r,o,a,c,u,v,m=e.cache;m&&(o=m.type,a=m.expired,c=m.version,u=m.encryption,void 0===o&&e.notModified&&h&&(o=h.from)),e.notModified?v=h?h.toData():null:(i=e.data,r=e.dataType,v="string"==typeof i?n(r,i):i),void 0!==o&&p(t.url,new d(i,r,a,c,u),o),s(v)},s))})}var v=["cipher","expired","version","encryption","wtime","rtime"],m=["value","expired","version","encryption"],l=function(){function t(t,e,i){this.value=t,this.version=e,this.from=i}return t.prototype.toData=function(){if(void 0===this._data){var t=this.value.indexOf(","),e=this.value.substr(t+1),i=this.value.substr(0,t);this._data=n(i,e)}return this._data},t}();e.CacheResult=l,e.parseContent=n;var d=function(){function t(t,e,i,n,r){this.data=t,this.dataType=e,this.expired=i,this.version=n,this.encryption=r}return t.prototype.toValue=function(){if(void 0===this._str&&void 0!==this.data){var t=this.dataType||"text";if("string"==typeof this.data)this._str=t+","+this.data;else{var e=w.serializations[t];this._str=t+","+(e?e.encode(this.data):this.data.toString())}}return this._str},t.prototype.toOptions=function(){var t=r(m,{},this);return t.value=this.toValue(),t},t}();e.CacheContent=d;var f=function(){function t(e){this._checkValidTime=-1,this.expired="20",this.version="",this.encryption=!1,this.wtime="0",this.rtime="0",e&&(e instanceof t?r(t.Props,this,e.toPropsData()):(this.expired=e.expired,this.version=e.version,this.encryption=e.encryption,this.wtime=e.wtime,this.rtime=e.rtime,this._cipher=e.cipher))}return t.prototype.getValue=function(){return void 0===this._value&&(this.encryption&&this._cipher?this._value=w.encryption.decrypt(this._cipher):this._value=this._cipher+""),this._value},t.prototype.getCipher=function(){return void 0===this._cipher&&(this.encryption&&this._value?this._cipher=w.encryption.encrypt(this._value):this._cipher=this._value+""),this._cipher},t.prototype.getValid=function(){var t=Date.now();return t-this._checkValidTime>1e3&&(this._valid=this._countValid(),this._checkValidTime=t),this._valid},t.prototype._countValid=function(){var t=!0,e=parseInt(this.expired);return t=isNaN(e)?new Date<new Date(this.expired):e>0?i()-parseInt(this.wtime)<parseInt(this.expired):!(e=0),t||this.version?t?1:0:-1},t.prototype.toObject=function(){var t=this.getValid();return t==-1?null:0==t?{value:this.getValue(),version:this.version}:{value:this.getValue(),version:""}},t.prototype.toCacheData=function(){return{cipher:this.getCipher(),expired:this.expired,version:this.version,encryption:this.encryption,wtime:this.wtime,rtime:this.rtime}},t.prototype.toPropsData=function(){return r(t.Props,{},this)},t.prototype.setCacheOptions=function(t){this.rtime=this.wtime=i()+"",void 0!==t.value&&t.value!=this._value&&(this._value=t.value,this._cipher=void 0),void 0!==t.encryption&&t.encryption!=this.encryption&&(this.encryption=t.encryption,this._cipher=void 0),void 0!==t.expired&&(this.expired=t.expired),void 0!==t.version&&(this.version=t.version)},t.prototype.clone=function(){return new t(this)},t.prototype.updateReadTime=function(){this.rtime=i()+""},t}();f.Props=["_value","_cipher","_valid","_checkValidTime","expired","version","encryption","wtime","rtime"];var y,_=function(){function t(){this._data={}}return t.prototype.getItem=function(t){var e=this._data[t];return e?r(v,{},e):null},t.prototype.setItem=function(t,e){this._data[t]=r(v,{},e)},t.prototype.removeItem=function(t){delete this._data[t]},t.prototype.keys=function(){return Object.keys(this._data)},t.prototype.clear=function(){this._data={}},t}(),g=function(){function t(t){this.storage=t}return t.prototype.keys=function(){for(var t=[],e=0,i=this.storage.length;e<i;e++){var n=this.storage.key(e)||"";0==n.indexOf(w.namespace)&&t.push(n.substr(w.namespace.length))}return t},t.prototype.clear=function(){for(var t=0,e=this.keys();t<e.length;t++){var i=e[t];this.removeItem(i)}},t.prototype.getItem=function(t){var e=this.storage.getItem(w.namespace+t);if(!e)return null;var i=e.indexOf("|"),n=e.substr(0,i).split(","),r=n[0],o=n[1],s=n[2],a=n[3],p=n[4],h=!!s,c=e.substr(i+1);return{cipher:c,expired:r,version:o,encryption:h,wtime:a,rtime:p}},t.prototype.setItem=function(t,e){t=w.namespace+t;var i=e.expired+","+e.version+","+(e.encryption?"1":"")+","+e.wtime+","+e.rtime+"|"+e.cipher;this.storage.setItem(t,i)},t.prototype.removeItem=function(t){this.storage.removeItem(w.namespace+t)},t}(),I=function(){function t(t){this.enity=t,this._data={},this._clearUpUnitNum=1048576}return t.prototype.clear=function(){this._data={},this.enity.clear()},t.prototype._clearUp=function(t){for(var e=this.enity.keys(),i=0,n=function(t){i+=t.getCipher().length},r=[],o=0,s=e;o<s.length;o++){var a=s[o],p=this._getItem(a,n);p&&r.push({key:a,rtime:parseInt(p.rtime),item:p})}if(i-t<this._clearUpUnitNum){r.sort(function(t,e){var i=t.rtime,n=e.rtime;return i==n?0:i<n?-1:1});for(var h=0,c=r;h<c.length;h++){var u=c[h],a=u.key;if(this._data[a]=null,this.enity.removeItem(a),n(u.item),i-t>=this._clearUpUnitNum)return}}},t.prototype.getItem=function(t){var e=this._getItem(t);return e?(e.updateReadTime(),this._setItem(t,e),e.toObject()):null},t.prototype._getItem=function(t,e){if(!this._data.hasOwnProperty(t)){var i=this.enity.getItem(t);this._data[t]=i?new f(i):null}var n=this._data[t];if(!n)return null;var r=n.getValid();return r==-1?(this._data[t]=null,this.enity.removeItem(t),e&&e(n),null):n.clone()},t.prototype.setItem=function(t,e){var i=this._getItem(t);return i||(i=new f),i.setCacheOptions(e),this._setItem(t,i)},t.prototype._setItem=function(t,e){var i=e.toCacheData();try{this.enity.setItem(t,i)}catch(e){this._clearUp(i.cipher.length);try{this.enity.setItem(t,i)}catch(t){return!1}}return this._data[t]=e,!0},t.prototype.removeItem=function(t){this.enity.removeItem(t)},t}(),w={namespace:"_pt_",encryption:{encrypt:function(t){return t},decrypt:function(t){return t}},serializations:{json:{encode:function(t){return JSON.stringify(t)},decode:function(t){return JSON.parse(t)}},text:{encode:function(t){return t},decode:function(t){return t}}},mappingKey:function(t){return t}};!function(t){t[t.Ram=0]="Ram",t[t.Session=1]="Session",t[t.Local=2]="Local"}(y=e.CacheType||(e.CacheType={}));var x={};x[y.Ram]=new I(new _),x[y.Session]=new I(new g(sessionStorage)),x[y.Local]=new I(new g(localStorage)),e.setConfig=s,e.getItem=a,e.setItem=p,e.removeItem=h,e.clear=c;var O;e.load=u});