/*!
 * Copyright po-to.org All Rights Reserved.
 * https://github.com/po-to/
 * Licensed under the MIT license
 */
define(["require","exports"],function(t,e){"use strict";function i(){return Math.floor(Date.now()/1e3)}function r(t,e){var i=x.serializations[t];return i?i.decode(e):e}function n(t,e){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];for(var n=0,o=i;n<o.length;n++)for(var a=o[n],s=0,c=t;s<c.length;s++){var h=c[s];a.hasOwnProperty(h)&&(e[h]=a[h])}return e}function o(t){for(var e=[],i=1;i<arguments.length;i++)e[i-1]=arguments[i];for(var r=0,n=e;r<n.length;r++){var o=n[r];for(var a in o)o.hasOwnProperty(a)&&(t[a]=o[a])}return t}function a(t){t.namespace&&(x.namespace=t.namespace),x.ramStorageLimit=t.ramStorageLimit||0,t.encryption&&(x.encryption=t.encryption),t.mappingKey&&(x.mappingKey=t.mappingKey),t.serializations&&o(x.serializations,t.serializations),t.request&&(O=t.request),t.taskCounter&&(l=t.taskCounter)}function s(t,e){t=x.mappingKey(t);var i;return void 0!==e?i=S[e].getItem(t):(e=y.Ram,i=S[e].getItem(t),i||(e=y.Session,i=S[e].getItem(t)),i||(e=y.Local,i=S[e].getItem(t))),i?new d(i.value,i.version,e):null}function c(t,e,i){t=x.mappingKey(t);var r=e.toOptions();return void 0===i&&(i=y.Ram),S[i].setItem(t,r)}function h(t,e){t=x.mappingKey(t),void 0!==e?S[e].removeItem(t):(S[y.Ram].removeItem(t),S[y.Session].removeItem(t),S[y.Local].removeItem(t))}function p(t){void 0!==t?S[t].clear():(S[y.Ram].clear(),S[y.Session].clear(),S[y.Local].clear())}function u(t,e,i){var n=new Promise(function(n,o){var a=function(r){var a=t.render?t.render(r):r;a instanceof Error?(i&&i(a),o(a)):(e&&e(a),n(a))},h=s(t.url);h&&!h.version?a(h.toData()):(h&&h.version&&(t.version=h.version),O(t,function(e){var i,n,o,s,p,u,l,v=e.cache;v&&(o=v.type,s=v.expired,p=v.version,u=v.encryption,void 0===o&&e.notModified&&h&&(o=h.from)),e.notModified?l=h?h.toData():null:(i=e.data,n=e.dataType,l="string"==typeof i?r(n,i):i),void 0!==o&&c(t.url,new f(i,n,s,p,u),o),a(l)},a))});return!t.hideLoading&&l&&l.addItem(n,t.note),n}Object.defineProperty(e,"__esModule",{value:!0});var l,v=["cipher","expired","version","encryption","wtime","rtime"],m=["value","expired","version","encryption"],d=function(){function t(t,e,i){this.value=t,this.version=e,this.from=i}return t.prototype.toData=function(){if(void 0===this._data){var t=this.value.indexOf(","),e=this.value.substr(t+1),i=this.value.substr(0,t);this._data=r(i,e)}return this._data},t}();e.CacheResult=d;var f=function(){function t(t,e,i,r,n){void 0===e&&(e="json"),void 0===i&&(i="-1"),this.data=t,this.dataType=e,this.expired=i,this.version=r,this.encryption=n}return t.prototype.toValue=function(){if(void 0===this._str&&void 0!==this.data){var t=this.dataType||"text";if("string"==typeof this.data)this._str=t+","+this.data;else{var e=x.serializations[t];this._str=t+","+(e?e.encode(this.data):this.data.toString())}}return this._str},t.prototype.toOptions=function(){var t=n(m,{},this);return t.value=this.toValue(),t},t}();e.CacheContent=f;var y,_=function(){function t(e){this._checkValidTime=-1,this.expired="20",this.version="",this.encryption=!1,this.wtime="0",this.rtime="0",e&&(e instanceof t?n(t.Props,this,e.toPropsData()):(this.expired=e.expired,this.version=e.version,this.encryption=e.encryption,this.wtime=e.wtime,this.rtime=e.rtime,this._cipher=e.cipher))}return t.prototype.getValue=function(){return void 0===this._value&&(this.encryption&&this._cipher?this._value=x.encryption.decrypt(this._cipher):this._value=this._cipher+""),this._value},t.prototype.getCipher=function(){return void 0===this._cipher&&(this.encryption&&this._value?this._cipher=x.encryption.encrypt(this._value):this._cipher=this._value+""),this._cipher},t.prototype.getValid=function(){var t=Date.now();return t-this._checkValidTime>1e3&&(this._valid=this._countValid(),this._checkValidTime=t),this._valid},t.prototype._countValid=function(){var t=!0,e=parseInt(this.expired);return t=isNaN(e)?new Date<new Date(this.expired):e>0?i()-parseInt(this.wtime)<parseInt(this.expired):0!=e,t||this.version?t?1:0:-1},t.prototype.toObject=function(){var t=this.getValid();return-1==t?null:0==t?{value:this.getValue(),version:this.version}:{value:this.getValue(),version:""}},t.prototype.toCacheData=function(){return{cipher:this.getCipher(),expired:this.expired,version:this.version,encryption:this.encryption,wtime:this.wtime,rtime:this.rtime}},t.prototype.toPropsData=function(){return n(t.Props,{},this)},t.prototype.setCacheOptions=function(t){this.rtime=this.wtime=i()+"",void 0!==t.value&&t.value!=this._value&&(this._value=t.value,this._cipher=void 0),void 0!==t.encryption&&t.encryption!=this.encryption&&(this.encryption=t.encryption,this._cipher=void 0),void 0!==t.expired&&(this.expired=t.expired,this._checkValidTime=-1),void 0!==t.version&&(this.version=t.version)},t.prototype.clone=function(){return new t(this)},t.prototype.updateReadTime=function(){this.rtime=i()+""},t.Props=["_value","_cipher","_valid","_checkValidTime","expired","version","encryption","wtime","rtime"],t}(),g=function(){function t(){this._data={},this._size=0}return t.prototype.getItem=function(t){var e=this._data[t];return e?n(v,{},e):null},t.prototype.setItem=function(t,e){var i=this._size+t.length+e.cipher.length;if(x.ramStorageLimit&&i>x.ramStorageLimit)throw"ramStorage overflowÔºÅ";this._size=i,this._data[t]=n(v,{},e)},t.prototype.removeItem=function(t){var e=this._data[t];e&&(this._size-=t.length+e.cipher.length,delete this._data[t])},t.prototype.keys=function(){return Object.keys(this._data)},t.prototype.clear=function(){this._data={}},t}(),I=function(){function t(t){this.storage=t}return t.prototype.keys=function(){for(var t=[],e=0,i=this.storage.length;e<i;e++){var r=this.storage.key(e)||"";0==r.indexOf(x.namespace)&&t.push(r.substr(x.namespace.length))}return t},t.prototype.clear=function(){for(var t=0,e=this.keys();t<e.length;t++){var i=e[t];this.removeItem(i)}},t.prototype.getItem=function(t){var e=this.storage.getItem(x.namespace+t);if(!e)return null;var i=e.indexOf("|"),r=e.substr(0,i).split(","),n=r[0],o=r[1],a=r[2],s=r[3],c=r[4],h=!!a;return{cipher:e.substr(i+1),expired:n,version:o,encryption:h,wtime:s,rtime:c}},t.prototype.setItem=function(t,e){t=x.namespace+t;var i=e.expired+","+e.version+","+(e.encryption?"1":"")+","+e.wtime+","+e.rtime+"|"+e.cipher;this.storage.setItem(t,i)},t.prototype.removeItem=function(t){this.storage.removeItem(x.namespace+t)},t}(),w=function(){function t(t){this.enity=t,this._data={},this._clearUpUnitNum=1048576}return t.prototype.clear=function(){this._data={},this.enity.clear()},t.prototype._clearUp=function(t){for(var e=this.enity.keys(),i=0,r=function(t){i+=t.getCipher().length},n=[],o=0,a=e;o<a.length;o++){var s=a[o],c=this._getItem(s,r);c&&n.push({key:s,rtime:parseInt(c.rtime),item:c})}if(i-t<this._clearUpUnitNum){n.sort(function(t,e){var i=t.rtime,r=e.rtime;return i==r?0:i<r?-1:1});for(var h=0,p=n;h<p.length;h++){var u=p[h],s=u.key;if(this._data[s]=null,this.enity.removeItem(s),r(u.item),i-t>=this._clearUpUnitNum)return}}},t.prototype.getItem=function(t){var e=this._getItem(t);return e?(e.updateReadTime(),this._setItem(t,e),e.toObject()):null},t.prototype._getItem=function(t,e){if(!this._data.hasOwnProperty(t)){var i=this.enity.getItem(t);this._data[t]=i?new _(i):null}var r=this._data[t];return r?-1==r.getValid()?(this._data[t]=null,this.enity.removeItem(t),e&&e(r),null):r.clone():null},t.prototype.setItem=function(t,e){var i=this._getItem(t);return i||(i=new _),i.setCacheOptions(e),this._setItem(t,i)},t.prototype._setItem=function(t,e){var i=e.toCacheData();try{this.enity.setItem(t,i)}catch(e){this._clearUp(i.cipher.length);try{this.enity.setItem(t,i)}catch(t){return!1}}return this._data[t]=e,!0},t.prototype.removeItem=function(t){this.enity.removeItem(t)},t}(),x={namespace:"_pt_",ramStorageLimit:0,encryption:{encrypt:function(t){return t},decrypt:function(t){return t}},serializations:{json:{encode:function(t){return JSON.stringify(t)},decode:function(t){return JSON.parse(t)}},text:{encode:function(t){return t},decode:function(t){return t}},xml:{encode:function(t){return window.XMLSerializer?(new XMLSerializer).serializeToString(t):t.xml},decode:function(t){if(!(t=t.trim()))return null;var e=null;if(window.DOMParser)try{e=(new DOMParser).parseFromString(t,"text/xml")}catch(t){console.log(t)}else for(var i=["MSXML.2.DOMDocument.6.0","Microsoft.XMLDOM"],r=0,n=i.length;r<n;r++)try{e=new window.ActiveXObject(i[r]),e.async=!1,e.loadXML(t)}catch(t){console.log(t)}return e}}},mappingKey:function(t){return t}};!function(t){t[t.Ram=0]="Ram",t[t.Session=1]="Session",t[t.Local=2]="Local"}(y=e.CacheType||(e.CacheType={}));var S={};S[y.Ram]=new w(new g),S[y.Session]=new w(new I(sessionStorage)),S[y.Local]=new w(new I(localStorage)),e.setConfig=a,e.getItem=s,e.setItem=c,e.removeItem=h,e.clear=p;var O=function(t,e,i){};e.load=u});